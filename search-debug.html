<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Debug - Markrypt</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .debug-container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .results {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      background: #fafafa;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="debug-container">
    <h1>üêõ Search Debug Console</h1>
    <p>This page helps debug search functionality issues.</p>
    
    <div class="test-section">
      <h3>üìä System Status</h3>
      <div id="system-status"></div>
    </div>
    
    <div class="test-section">
      <h3>üîç Search Tests</h3>
      <input type="text" id="search-input" placeholder="Enter search term..." style="padding: 10px; width: 300px; margin-right: 10px;">
      <button onclick="testSearch()">Search</button>
      <button onclick="testSearch('banana')">Search "banana"</button>
      <button onclick="testSearch('laptop')">Search "laptop"</button>
      <button onclick="testSearch('phone')">Search "phone"</button>
      <div class="results" id="search-results"></div>
    </div>
    
    <div class="test-section">
      <h3>üì¶ Product Data Analysis</h3>
      <button onclick="analyzeProducts()">Analyze Loaded Products</button>
      <div class="results" id="product-analysis"></div>
    </div>
    
    <div class="test-section">
      <h3>üîß Debug Console</h3>
      <div class="results" id="debug-console"></div>
    </div>
  </div>

  <script src="assets/js/global-products-loader.js"></script>
  <script src="assets/js/search-manager.js"></script>
  <script>
    let debugLog = [];
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      debugLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
      updateDebugConsole();
      console.log(`[DEBUG] ${message}`);
    }
    
    function updateDebugConsole() {
      const console = document.getElementById('debug-console');
      console.innerHTML = '<pre>' + debugLog.slice(-20).join('\n') + '</pre>';
      console.scrollTop = console.scrollHeight;
    }
    
    async function checkSystemStatus() {
      const status = document.getElementById('system-status');
      let html = '';
      
      // Check GlobalProductsLoader
      if (window.globalProductsLoader) {
        html += '<div class="success">‚úÖ GlobalProductsLoader available</div>';
        try {
          const products = await window.globalProductsLoader.getProducts();
          html += `<div class="success">‚úÖ Loaded ${products.length} products</div>`;
          log(`GlobalProductsLoader loaded ${products.length} products`);
        } catch (error) {
          html += `<div class="error">‚ùå Error loading products: ${error.message}</div>`;
          log(`Error loading products: ${error.message}`, 'error');
        }
      } else {
        html += '<div class="error">‚ùå GlobalProductsLoader not available</div>';
        log('GlobalProductsLoader not available', 'error');
      }
      
      // Check SearchManager
      if (window.searchManager) {
        html += '<div class="success">‚úÖ SearchManager available</div>';
        try {
          await window.searchManager.init();
          const productCount = window.searchManager.products ? window.searchManager.products.length : 0;
          html += `<div class="success">‚úÖ SearchManager initialized with ${productCount} products</div>`;
          log(`SearchManager initialized with ${productCount} products`);
        } catch (error) {
          html += `<div class="error">‚ùå Error initializing SearchManager: ${error.message}</div>`;
          log(`Error initializing SearchManager: ${error.message}`, 'error');
        }
      } else {
        html += '<div class="error">‚ùå SearchManager not available</div>';
        log('SearchManager not available', 'error');
      }
      
      // Check MARKRYPT namespace
      if (window.MARKRYPT) {
        html += '<div class="info">‚ÑπÔ∏è MARKRYPT namespace available</div>';
        const categories = Object.keys(window.MARKRYPT).filter(key => key.endsWith('Products'));
        html += `<div class="info">‚ÑπÔ∏è Found ${categories.length} category data sets: ${categories.join(', ')}</div>`;
        log(`MARKRYPT namespace has ${categories.length} categories`);
      } else {
        html += '<div class="error">‚ùå MARKRYPT namespace not available</div>';
        log('MARKRYPT namespace not available', 'error');
      }
      
      status.innerHTML = html;
    }
    
    async function testSearch(query) {
      if (!query) {
        query = document.getElementById('search-input').value.trim();
      }
      
      if (!query) {
        alert('Please enter a search term');
        return;
      }
      
      const results = document.getElementById('search-results');
      results.innerHTML = `<div class="info">üîç Searching for "${query}"...</div>`;
      log(`Testing search for: "${query}"`);
      
      try {
        if (!window.searchManager) {
          results.innerHTML = '<div class="error">‚ùå SearchManager not available</div>';
          log('SearchManager not available for search', 'error');
          return;
        }
        
        // Ensure SearchManager is initialized
        await window.searchManager.init();
        
        const searchResults = window.searchManager.search(query);
        log(`Search returned ${searchResults ? searchResults.length : 0} results`);
        
        if (searchResults && searchResults.length > 0) {
          let html = `<div class="success">‚úÖ Found ${searchResults.length} results for "${query}":</div>`;
          searchResults.slice(0, 10).forEach((product, index) => {
            html += `
              <div style="border-bottom: 1px solid #eee; padding: 8px 0; margin: 5px 0;">
                <strong>${index + 1}. ${product.name || product.title || 'Unknown'}</strong><br>
                <small>
                  Category: ${product.category || 'Unknown'} | 
                  Price: ${product.price || 'N/A'} | 
                  ID: ${product.id || 'N/A'}
                </small><br>
                <small style="color: #666;">
                  ${(product.description || '').substring(0, 100)}${product.description && product.description.length > 100 ? '...' : ''}
                </small>
              </div>
            `;
          });
          if (searchResults.length > 10) {
            html += `<div class="info">... and ${searchResults.length - 10} more results</div>`;
          }
          results.innerHTML = html;
        } else {
          results.innerHTML = `<div class="error">‚ùå No results found for "${query}"</div>`;
          log(`No results found for "${query}"`, 'error');
          
          // Debug: Check what products are available
          if (window.searchManager.products) {
            log(`Total products available: ${window.searchManager.products.length}`);
            const sampleProducts = window.searchManager.products.slice(0, 5);
            log(`Sample products: ${sampleProducts.map(p => p.name || p.title).join(', ')}`);
          }
        }
      } catch (error) {
        results.innerHTML = `<div class="error">‚ùå Search error: ${error.message}</div>`;
        log(`Search error: ${error.message}`, 'error');
      }
    }
    
    async function analyzeProducts() {
      const analysis = document.getElementById('product-analysis');
      analysis.innerHTML = '<div class="info">üîç Analyzing products...</div>';
      log('Starting product analysis');
      
      try {
        let allProducts = [];
        
        // Get products from GlobalProductsLoader
        if (window.globalProductsLoader) {
          allProducts = await window.globalProductsLoader.getProducts();
          log(`GlobalProductsLoader has ${allProducts.length} products`);
        }
        
        // Get products from SearchManager
        let searchProducts = [];
        if (window.searchManager && window.searchManager.products) {
          searchProducts = window.searchManager.products;
          log(`SearchManager has ${searchProducts.length} products`);
        }
        
        // Analyze categories
        const categories = {};
        allProducts.forEach(product => {
          const category = product.category || 'Unknown';
          categories[category] = (categories[category] || 0) + 1;
        });
        
        // Look for banana products specifically
        const bananaProducts = allProducts.filter(product => {
          const searchText = `${product.name || ''} ${product.title || ''} ${product.description || ''}`.toLowerCase();
          return searchText.includes('banana');
        });
        
        let html = `
          <div class="success">üìä Analysis Complete</div>
          <div><strong>Total Products:</strong> ${allProducts.length}</div>
          <div><strong>SearchManager Products:</strong> ${searchProducts.length}</div>
          <div><strong>Banana Products Found:</strong> ${bananaProducts.length}</div>
          <div><strong>Categories:</strong></div>
          <ul>
        `;
        
        Object.entries(categories).forEach(([category, count]) => {
          html += `<li>${category}: ${count} products</li>`;
        });
        
        html += '</ul>';
        
        if (bananaProducts.length > 0) {
          html += '<div><strong>Banana Products:</strong></div><ul>';
          bananaProducts.forEach(product => {
            html += `<li>${product.name || product.title} (${product.category})</li>`;
          });
          html += '</ul>';
        }
        
        analysis.innerHTML = html;
        log(`Analysis complete: ${allProducts.length} total, ${bananaProducts.length} banana products`);
        
      } catch (error) {
        analysis.innerHTML = `<div class="error">‚ùå Analysis error: ${error.message}</div>`;
        log(`Analysis error: ${error.message}`, 'error');
      }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      log('Debug page loaded');
      
      // Wait for scripts to initialize
      setTimeout(async () => {
        await checkSystemStatus();
      }, 1000);
    });
    
    // Allow Enter key in search input
    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        testSearch();
      }
    });
  </script>
</body>
</html>
